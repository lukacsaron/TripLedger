// TripLedger Prisma Schema
// Holiday expense tracking with fixed exchange rates

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Trip model - represents a holiday/trip
model Trip {
  id          String     @id @default(cuid())
  name        String
  countryCode String?    // ISO 3166-1 alpha-2 code (e.g., 'HU', 'US')
  startDate   DateTime
  endDate     DateTime?
  budgetHuf   Int        @default(0)

  // Fixed exchange rates established at start of trip
  rateEurToHuf Float     @default(1)
  rateUsdToHuf Float     @default(1)
  rateHrkToHuf Float     @default(1)

  // Payer management (relation for SQLite)
  payers      Payer[]

  // Default settings
  defaultPayer String?   // Last used or preferred payer

  expenses    Expense[]
  tripBudgets TripBudget[]

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([createdAt])
}

// Payer model - to replace String[] for SQLite compatibility
model Payer {
  id     String @id @default(cuid())
  name   String
  tripId String
  trip   Trip   @relation(fields: [tripId], references: [id], onDelete: Cascade)

  @@index([tripId])
}

// Expense model - individual transactions
model Expense {
  id              String    @id @default(cuid())
  tripId          String
  trip            Trip      @relation(fields: [tripId], references: [id], onDelete: Cascade)

  date            DateTime  @default(now())
  merchant        String
  payer           String
  paymentType     String    @default("CASH") // SQLite doesn't support enums

  // Money logic - store both original and converted amounts
  amountOriginal  Decimal
  currency        String    // SQLite doesn't support enums
  amountHuf       Decimal   // Calculated from original + currency + trip rates

  // AI parsing metadata
  isAiParsed      Boolean   @default(false)
  needsReview     Boolean   @default(false)
  rawItemsText    String?   // Full text list of items from receipt

  categoryId      String
  category        Category  @relation(fields: [categoryId], references: [id])
  
  subcategoryId   String?
  subcategory     Subcategory? @relation(fields: [subcategoryId], references: [id])

  description     String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([tripId])
  @@index([categoryId])
  @@index([subcategoryId])
  @@index([date])
}

// Global Category model - shared across all trips
model Category {
  id        String    @id @default(cuid())
  name      String    @unique
  color     String    @default("#E5E7EB")  // Pastel colors for "Zen Accounting"
  icon      String?   // Optional icon name (e.g., "utensils" for Food)

  expenses      Expense[]
  subcategories Subcategory[]
  tripBudgets   TripBudget[]

  createdAt DateTime  @default(now())
}

// Subcategory model - hierarchical organization
model Subcategory {
  id         String   @id @default(cuid())
  name       String
  
  categoryId String
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  expenses   Expense[]

  createdAt  DateTime @default(now())

  @@unique([categoryId, name])
}

// TripBudget model - per-trip budgeting for global categories
model TripBudget {
  id         String   @id @default(cuid())
  amount     Int      @default(0)

  tripId     String
  trip       Trip     @relation(fields: [tripId], references: [id], onDelete: Cascade)

  categoryId String
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([tripId, categoryId])
  @@index([tripId])
}
